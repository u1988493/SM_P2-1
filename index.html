<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Carrera de Plataformes</title>
  <link rel="icon" href="favicon.png" />
  <style>
    body { margin:0; padding:20px; font-family: Arial, sans-serif; background:#87CEEB; display:flex; flex-direction:column; align-items:center; }
    #estat { color:#333; margin-bottom:10px; }
    #joc { display:none; }
    #puntuacio { background:#fff; padding:10px; border-radius:5px; margin-bottom:10px; font-size:18px; font-weight:bold; }
    #canvas { background:linear-gradient(to bottom,#87CEEB 0%,#B0E0E6 100%); border:3px solid #333; display:block; box-shadow:0 4px 8px rgba(0,0,0,.3); }
    .controls { margin-top:10px; color:#333; background:#fff; padding:10px; border-radius:5px; }
    #ping { background:#fff; padding:8px 12px; border-radius:5px; margin-bottom:10px; font-size:14px; font-weight:bold; }
    .ping-good{ color:#28a745 } .ping-medium{ color:#ffc107 } .ping-bad{ color:#dc3545 }
  </style>
</head>
<body>
  <h1 id="estat">Connectant al joc...</h1>
  <div id="joc">
    <h2 id="puntuacio">Jugador 1: 0 | Jugador 2: 0</h2>
    <div id="ping">Ping: -- ms</div>
    <canvas id="canvas" width="400" height="600"></canvas>
    <div class="controls">
      <strong>Controls:</strong> Fletxes esquerra/dreta per moure's, Espai per saltar<br />
      <strong>Objectiu:</strong> Arribar a les plataformes daurades abans que el teu oponent! Primer a 100 punts guanya!
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const textEstat = document.getElementById('estat');
    const divJoc = document.getElementById('joc');
    const textPuntuacio = document.getElementById('puntuacio');
    const textPing = document.getElementById('ping');

    let idJoc, idJugador, esPrimerJugador = false, guanyador = null;

    // jugador local
    let jugador = { x:50, y:550, width:30, height:30, velocityY:0, velocityX:0, gravity:0.6, jumpPower:-15, moveSpeed:6, score:0, color:'#FF6B6B', onGround:false };
    // oponent
    let oponent = { x:350, y:550, score:0, color:'#4ECDC4' };

    let plataformasEstaticas = [];
    let plataformaPuntos = null;
    let teclesPremes = {};
    let lastJumpTime = 0;

    // Ping
    let pingMs = 0, pingHistory = [];
    const maxPingHistory = 10;
    function actualizarPing(lat) {
      pingHistory.push(lat);
      if (pingHistory.length > maxPingHistory) pingHistory.shift();
      pingMs = Math.round(pingHistory.reduce((a,b)=>a+b,0)/pingHistory.length);
      textPing.textContent = `Ping: ${pingMs} ms`;
      textPing.className = '';
      textPing.classList.add(pingMs<50?'ping-good': pingMs<100?'ping-medium':'ping-bad');
    }

    // Helpers fetch JSON robusto (evita parsear HTML de error)
    async function fetchJSON(url, options={}) {
      const res = await fetch(url, options);
      const text = await res.text();
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} - ${text.slice(0,200)}`);
      }
      try { return JSON.parse(text); }
      catch {
        throw new Error(`Resposta no JSON (possiblement 404/HTML): ${text.slice(0,200)}`);
      }
    }

    document.addEventListener('keydown', (e) => {
      teclesPremes[e.key] = true;
      if ((e.key === ' ' || e.key === 'ArrowUp') && jugador.onGround) {
        const now = Date.now();
        if (now - lastJumpTime > 200) {
          jugador.velocityY = jugador.jumpPower;
          jugador.onGround = false;
          lastJumpTime = now;
        }
      }
    });
    document.addEventListener('keyup', (e) => { teclesPremes[e.key] = false; });

    async function unirseAlJoc() {
      try {
        const data = await fetchJSON('./game.php?action=join');
        idJoc = data.game_id;
        idJugador = data.player_id;
        comprovarEstatDelJoc();
      } catch (err) {
        console.error(err);
        textEstat.textContent = `No s'ha pogut connectar: ${err.message}`;
        // Reintento suave
        setTimeout(unirseAlJoc, 1000);
      }
    }

    async function comprovarEstatDelJoc() {
      const t0 = performance.now();
      try {
        const joc = await fetchJSON(`./game.php?action=status&game_id=${encodeURIComponent(idJoc)}`);
        const t1 = performance.now();
        actualizarPing(t1 - t0);

        if (joc.error) { textEstat.textContent = joc.error; return; }

        plataformasEstaticas = joc.platforms || [];
        plataformaPuntos = joc.point_platform || null;
        guanyador = joc.winner;
        esPrimerJugador = (joc.player1 === idJugador);

        if (esPrimerJugador) {
          jugador.color = '#FF6B6B'; oponent.color = '#4ECDC4';
          oponent.x = joc.player2_x ?? 350; oponent.y = joc.player2_y ?? 550;
          oponent.score = (joc.points?.[1]) ?? 0; jugador.score = (joc.points?.[0]) ?? 0;
        } else {
          jugador.color = '#4ECDC4'; oponent.color = '#FF6B6B';
          oponent.x = joc.player1_x ?? 50; oponent.y = joc.player1_y ?? 550;
          oponent.score = (joc.points?.[0]) ?? 0; jugador.score = (joc.points?.[1]) ?? 0;
        }

        textPuntuacio.textContent = `Jugador 1: ${joc.points?.[0] ?? 0} | Jugador 2: ${joc.points?.[1] ?? 0}`;

        if (guanyador) {
          textEstat.textContent = (guanyador === idJugador) ? 'ðŸŽ‰ Has guanyat! ðŸŽ‰' : 'ðŸ˜¢ Has perdut!';
          return;
        }

        if (joc.player1 && joc.player2) {
          textEstat.textContent = 'Carrera en curs! Primer a 100 punts guanya!';
          divJoc.style.display = 'block';
          if (!gameLoopStarted) { gameLoopStarted = true; gameLoop(); }
        } else if (esPrimerJugador) {
          textEstat.textContent = 'Ets el Jugador 1. Esperant el Jugador 2...';
        } else {
          textEstat.textContent = 'Ets el Jugador 2. ComenÃ§ant partida...';
        }

        if (!guanyador) setTimeout(comprovarEstatDelJoc, 100);
      } catch (err) {
        console.error(err);
        textEstat.textContent = `Error d'estat: ${err.message}`;
        setTimeout(comprovarEstatDelJoc, 500);
      }
    }

    let gameLoopStarted = false;
    let lastUpdateTime = Date.now();
    let lastServerUpdate = 0;

    function gameLoop() {
      if (guanyador) return;
      const now = Date.now();
      const dt = (now - lastUpdateTime) / 16.67;
      lastUpdateTime = now;
      update(dt); render(); requestAnimationFrame(gameLoop);
    }

    function update(deltaTime) {
      // moviment horitzontal
      if (teclesPremes['ArrowLeft'] || teclesPremes['a'] || teclesPremes['A']) jugador.velocityX = -jugador.moveSpeed;
      else if (teclesPremes['ArrowRight'] || teclesPremes['d'] || teclesPremes['D']) jugador.velocityX = jugador.moveSpeed;
      else jugador.velocityX = 0;

      jugador.x += jugador.velocityX * deltaTime;
      if (jugador.x < 0) jugador.x = 0;
      if (jugador.x + jugador.width > canvas.width) jugador.x = canvas.width - jugador.width;

      jugador.velocityY += jugador.gravity * deltaTime;
      jugador.y += jugador.velocityY * deltaTime;
      jugador.onGround = false;

      // terra
      if (jugador.y + jugador.height >= canvas.height - 10) {
        jugador.y = canvas.height - 10 - jugador.height;
        jugador.velocityY = 0; jugador.onGround = true;
      }

      // plataformes
      if (jugador.velocityY > 0) {
        for (let plat of plataformasEstaticas) {
          if (jugador.y + jugador.height >= plat.y &&
              jugador.y + jugador.height <= plat.y + 15 &&
              jugador.x + jugador.width > plat.x &&
              jugador.x < plat.x + plat.width) {
            jugador.y = plat.y - jugador.height;
            jugador.velocityY = 0; jugador.onGround = true; break;
          }
        }

        // plataforma de punts
        if (plataformaPuntos && plataformaPuntos.active) {
          if (jugador.y + jugador.height >= plataformaPuntos.y &&
              jugador.y + jugador.height <= plataformaPuntos.y + 15 &&
              jugador.x + jugador.width > plataformaPuntos.x &&
              jugador.x < plataformaPuntos.x + plataformaPuntos.width) {
            jugador.y = plataformaPuntos.y - jugador.height;
            jugador.velocityY = 0; jugador.onGround = true;

            if (plataformaPuntos.active) {
              plataformaPuntos.active = false;
              fetchJSON(`./game.php?action=collect&game_id=${encodeURIComponent(idJoc)}`)
                .then(d => { if (d.success) jugador.score += d.points || 0; })
                .catch(console.error);
            }
          }
        }
      }

      // enviar posiciÃ³ cada 100 ms
      const t = Date.now();
      if (t - lastServerUpdate > 100) {
        lastServerUpdate = t;
        fetch(`./game.php?action=update&game_id=${encodeURIComponent(idJoc)}&x=${jugador.x}&y=${jugador.y}`)
          .catch(console.error);
      }
    }

    function render() {
      ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#654321'; ctx.fillRect(0, canvas.height-10, canvas.width, 10);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(0, canvas.height-10, canvas.width, 10);

      // plataformes
      plataformasEstaticas.forEach(plat => {
        ctx.fillStyle = '#8B4513'; ctx.fillRect(plat.x, plat.y, plat.width, 10);
        ctx.strokeStyle = '#654321'; ctx.lineWidth = 2; ctx.strokeRect(plat.x, plat.y, plat.width, 10);
      });

      // plataforma punts
      if (plataformaPuntos && plataformaPuntos.active) {
        ctx.shadowColor = 'rgba(255, 215, 0, 0.5)'; ctx.shadowBlur = 10;
        ctx.fillStyle = '#FFD700'; ctx.fillRect(plataformaPuntos.x, plataformaPuntos.y, plataformaPuntos.width, 10);
        ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 2; ctx.strokeRect(plataformaPuntos.x, plataformaPuntos.y, plataformaPuntos.width, 10);
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#FF6347'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center';
        ctx.strokeStyle = '#FFF'; ctx.lineWidth = 3; ctx.strokeText(`+${plataformaPuntos.points}`, plataformaPuntos.x + plataformaPuntos.width/2, plataformaPuntos.y - 5);
        ctx.fillText(`+${plataformaPuntos.points}`, plataformaPuntos.x + plataformaPuntos.width/2, plataformaPuntos.y - 5);
      }

      // oponent
      ctx.fillStyle = oponent.color; ctx.fillRect(oponent.x, oponent.y, jugador.width, jugador.height);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(oponent.x, oponent.y, jugador.width, jugador.height);
      ctx.fillStyle = '#000'; ctx.fillRect(oponent.x+8, oponent.y+10, 4,4); ctx.fillRect(oponent.x+18, oponent.y+10, 4,4);

      // jugador
      ctx.fillStyle = jugador.color; ctx.fillRect(jugador.x, jugador.y, jugador.width, jugador.height);
      ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(jugador.x, jugador.y, jugador.width, jugador.height);
      ctx.fillStyle = '#000'; ctx.fillRect(jugador.x+8, jugador.y+10, 4,4); ctx.fillRect(jugador.x+18, jugador.y+10, 4,4);

      // puntuaciÃ³ local
      ctx.fillStyle = '#000'; ctx.font = 'bold 20px Arial'; ctx.textAlign = 'left';
      ctx.fillText(`Punts: ${jugador.score}`, 10, 30);
    }

    // arrencar
    unirseAlJoc();
  </script>
</body>
</html>
